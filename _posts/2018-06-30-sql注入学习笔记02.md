---
title: sql注入学习笔记02
categories:
- sql注入
tags:
- 学习笔记
updated: 2018-06-30
---



**SQLmap 注入类型解读** （非常重要的）

1.基于布尔的盲注。

 即可以根据返回页面判断条件真假的注入。

2.基于时间的盲注。

 即不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。 由于对错返回的页面一样，无法通过页面判断对错，就使用页面刷新 时间来判断对错； 

3.基于报错注入。  

 即页面会返回错误信息，或者把注入的语句的结果直接返回在页面 中。

 4.联合查询注入 可以使用 union 的情况下的注入。 

5.堆查询注入 可以同时执行多条语句的执行时的注入。 

***<u>一般性的 SQL 的注入步骤</u>*** 

**SQL 注入的种类** 

*sql盲注：*

   基于布尔 SQL 盲注 •

   基于时间的 SQL 盲注 

   基于报错的 SQL 盲注

​      ▲基于字符的注入 

​      ▲错误回显的 SQL 注入 

•基于如何处理输入的 SQL 查询（数据类型）

​      •基于字符串 

​     •数字或整数为基础的 

*<u>基于程度和顺序的注入(哪里发生了影响)</u>* <u></u>

​         ★一阶注射 

​         ★二阶注射 

一阶注射是指输入的注射语句对 WEB 直接产生了影响，出现了结果：

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_09.png" />

二阶注入类似存储型 XSS，是指输入提交的语句，无法直接对 WEB 应用程序产生影响，通过其它的辅助间接的对 WEB 产生危害，这样 的就被称为是二阶注入 

基于注入点的位置上的

 •▲通过用户输入的表单域的注射。

​          •传统的 POST/GET 

•▲通过 cookie 注射。 

​           •Cookie=XXXXXXXX

 •▲通过服务器变量注射。（基于头部信息的注射）

​           •Useragent= 



<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_10.png" />



***<u>sql中系统函数</u>*** （非常重要）



介绍几个常用函数： 

1. version()  MySQL 版本 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_11.png" />

​    2.user()  数据库用户名 



<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_12.png" />

3.  database()  数据库名 

   <img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_13.png" />

4.  @@datadir  数据库路径 

   <img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_14.png" />

5.  @@version_compile_os  操作系统版本 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_15.png" />

字符串连接函数函数具体介绍 • http://www.cnblogs.com/lcamry/p/5715634.html   

   1.concat(str1,str2,...)——没有分隔符地连接字符串。

  2.concat_ws(separator,str1,str2,...)——含有分隔符地连接字符串

  3.group_concat(str1,str2,...)——连接一个组的所有字符串，并以 逗号分隔每一条数据 

***<u>注入流程</u>*** 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_16.png" />

我们的数据库存储的数据按照上图的形式，一个数据库当中有很 多的数据表，数据表当中有很多的列，每一列当中存储着数据。我们 注入的过程就是先拿到数据库名，在获取到当前数据库名下的数据 表，再获取当前数据表下的列，最后获取数据。 获取数据库——数据表——列——数据 

在可以提交的参数后添加： 

Ps:--+可以用#替换，url 提交过程中 Url 编码后的#为%23

 •or1=1--+

 •'or1=1--+ 

•"or1=1--+ 

•)or1=1--+ 

•')or1=1--+ 

•")or1=1--+ 

•"))or1=1--+ 

一般的代码为： `𝑖𝑑 =_GET['id'];$sql="SELECT*FROMusersWHEREid='$id'LIMIT0 ,1";`

 •此处考虑两个点，一个是闭合前面你的‘另一个是处理后面的‘，

 一般采用两种思路，闭合后面的引号或者注释掉，注释掉采用--+或 者#（%23） 

Step1：找出数据库 数据库：

 Select schema_name from information_schema.schemata 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_17.png" />

Step2:表 

select table_name from information_schema.tables where table_sc hema=‘security’; 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_18.png" />



Step3:列 

  猜某表的所有列 

 Select column_name from information_schema.columns where ta ble_name=’users’ 

<img src="{{ site.url }}/assets//blog_images/sql注入学习笔记_19.png" />

Step4 获取内容：

 获取某列的内容 `Select *** from ****` 

information_schema 的说明 

​     information_schema 数据库是 MySQL 自带的，它提供了访问 数据库元数据的方式。什么是元数据呢？元数据是关于数据的数据 ，如数据库名或表名，列的数据类型，或访问权限等。有些时候用 于表述该信息的其他术语包括“数据词典”和“系统目录”。 

​      在 MySQL 中，把 information_schema 看作是一个数据库， 确切说是信息数据库。其中保存着关于 MySQL 服务器所维护的所有 其他数据库的信息。如数据库名，数据库的表，表栏的数据类型与访问权 限等。在 INFORMATION_SCHEMA 中，有数个只读表。它们 实际上是视图，而不是基本表，因此，你将无法看到与之相关的任何 文件。 



information_schema 数据库表说明: 

SCHEMATA 表：提供了当前 mysql 实例中所有数据库的信息。是 show databases 的结果取之此表。

 TABLES 表：提供了关于数据库中的表的信息（包括视图）。详细 表述了某个表属于哪个 schema，表类型，表引擎，创建时间等信息。 是 show tables from schema.name 的结果取之此表。

 COLUMNS 表：提供了表中的列信息。详细表述了某张表的所有 列以及每个列的信息。是 show columns from schemaname.tablename 的结果取之此表。 

***<u>盲注定义：</u>***

   何为盲注？ 盲注就是在 sql 注入过程中，sql 语句执行的选择后，选择的数据 不能回显到前端页面。 此时，我们需要利用一些方法进行判断或者尝试，这个过程称之为 盲注

我们可以知道盲注分为三类 

1. ​    基于布尔 SQL 盲注

2.    基于报错的 SQL 盲注 

3.    基于时间的 SQL 盲注 

    

   ***<u>基于时间的 SQL 盲注</u>*** 

   延时注入，用的最多的蛇皮注入

    常用的判断语句:

    ' and if(1=0,1, sleep(10)) --+ 

   " and if(1=0,1, sleep(10)) --+

    ) and if(1=0,1, sleep(10)) --+

    ') and if(1=0,1, sleep(10)) --+ 

   ") and if(1=0,1, sleep(10)) --+ 

   可以使用f12进行判断时间

   

   ***<u>基于字符型的 SQL 注入</u>*** 

   

   简而言之，基于字符型的 SQL 注入即存在 SQL 注入漏洞的 URL 参 数为字符串类型（需要使用单引号表示）。 

   字符型 SQL 注入的关键—–单引号的闭合

    mysql 数据库对于单引号的规则如下：

   ​      • 单引号必须成对出现，否则数据库就会报错。

   ​      • 如果两个单引号之间内容为空，数据库自动忽略。

    应用程序数据库的字符型 SQL 语句为： 

   ​     select * from tables where idproduct=’13’;

   ​    • select * from tables where name=’bike’;

   ​    • select * from tables where data=’01/01/2016’; 

   

   错误回显的 SQL 注入

    关于错误回显

    基于错误回显的 sql 注入就是通过 sql 语句的矛盾性来使数据被 回显到页面上。 

   所用到的函数

    用于错误回显的 sql 语句 

   第一种： 基于 rand() 与 group by 的错误 

   利用 group by part of rand() returns duplicate key error 这个 bug，关于rand()函数与group by 在mysql中的错误报告如下： RAND() in a WHERE clause is re-evaluated every time the WHERE is executed. You cannot use a column with RAND() values in an ORDER BY clause, because ORDER BY would evaluate the column multiple times. 

   这个 bug 会爆出 duplicate key 这个错误，然后顺便就把数据偷 到了。

    公式：username=admin’ and (select 1 from (select count(), concat(floor(rand(0)2),0x23,(你想获取的数据的 sql 语句))x from information_schema.tables group by x )a) and ‘1’ = ‘1

    第二种： XPATH 爆信息

    这里主要用到的是 ExtractValue()和 UpdateXML()这 2 个函数， 由于 mysql 5.1 以后提供了内置的 XML 文件解析和函数，所以 这种注入只能用于 5.1 版本以后使用 查看 sql 手册

    作用：从目标 XML 中返回包含所查询值的字符串 

   作用：改变文档中符合条件的节点的值

    现在就很清楚了，我们只需要不满足 XPath_string(Xpath 格式) 就可以了，但是由于这个方法只能爆出 32 位，所以可以结合 mid 来使用 公式 1：username=admin’ and (extractvalue(1, concat(0x7e,(你想获取的数据的 sql 语句)))) and ‘1’=’1 

   公 式 2：username=admin’and (updatexml(1, concat(0x7e,(你 想获取的数据的 sql 语句)),1)) and ‘1’=’1

    基于错误回显的注入，总结起来就一句话，通过 sql 语句的矛盾 性来使数据被回显到页面上，但有时候局限于回显只能回显一 条，导致基于错误的注入偷数据的效率并没有那么高，但相对于 布尔注入已经提高了一个档次 

    **sql 注入一般步骤详解** 

   **一.选取 SQL 注入的地址 在浏览器的搜索框中输入**：

   公司 inurl asp?id=，然后点击搜索按 钮，会列出所有 asp 相关的网站信息，从中选取一个 这里我们选取

    http://www.zhjxxx.com/ship.asp?id=4 

   回车之后，会发现页面显示错误如下：

    Microsoft OLE DB Provider for ODBC Drivers error '80040e14' Microsoft Syntax error in string in query expression 'shipline.id=ship.shiplineid and shipline.groundid=ground.id and ground.id=4' order by shiptime'. /ship.asp, line 107 

   从上面这段错误，我们可以看出以下几点内容：

    （1）网站使用的是 Access 数据库，通过 ODBC 连接数据库。

    （2） 程序没有判断客户端提交的数据是否符合程序要求

    （3）该 SQL 语句所查询的表中有一名为 ID 的字段。

    从上面的例子我们可以知 道，ＳＱＬ注入的原理，就是从客户端提交特殊的代码，从而收集程序及服务器的信息，从而获取你想到得到的资料。

   **二、判断是否可以进行 SQL 注入**   

   看完第一节，是否感觉 SQL 注入测试不是很简单吗？其实，这并不 是最好的方法，为什么呢？ 首先，不一定每台服务器的 IIS 都返回 具体错误提示给客户端，如果程序中加了 cint(参数)之类语句的话， ＳＱＬ注入是不会成功的，但服务器同样会报错，具体提示信息为处 理 URL 时服务器上出错。请和系统管理员联络。 其次，部分对Ｓ ＱＬ注入有一点了解的程序员，认为只要把单引号过滤掉就安全了， 这种情况不为少数，如果你用单引号测试，是测不到注入点的 那么， 什么样的测试方法才是比较准确呢？答案如下： 

     http://www.wenkuxiazai.com/showdetail.asp?id=49①

    http://www.wenkuxiazai.com/showdetail.asp?id=49② and 1=1

    http://www.wenkuxiazai.com/showdetail.asp?id=49③ and 1=2 

   这就是经典的 1=1、1=2 测试法了，怎么判断呢？看看上面三个网 址返回的结果就知道了： 可以注入的表现： 

   ① 正常显示（这是必 然的，不然就是程序有错误了）

    ② 正常显示，内容基本与①相同

    ③ 提示 BOF 或 EOF（程序没做任何判断时）、或提示找不到记录（判 断了 rs.eof 时）、或显示内容为空（程序加了 on error resume next） 

   不可以注入就比较容易判断了

    ①同样正常显示 

   ②和③一般都会有 程序定义的错误提示，或提示类型转换时出错。 当然，这只是传入参数是数字型的时候用的判断方法，实际应用的时候会有字符型和搜 索型参数

   **三. 判断数据库类型及注入方法**

    不同的数据库的函数、注入方法都是有差异的，所以在注入之前，我 们还要判断一下数据库的类型。

   一般 ASP 最常搭配的数据库是 Access 和 SQLServer，网上超过 99%的网站都是其中之一。

    **途径一：直接从出错信息获取** 

   SQLServer 有一些系统变量，如果服务器 IIS 提示没关闭，并且 SQLServer 返回错误提示的话，那可以直接从出错信息获取，方法如下： 

   http://www.wenkuxiazai.com/showdetail.asp?id=49 and user>0 

   它的含 义： 首先，前面的语句是正常的，重点在 and user>0，user 是 SQLServer 的 一个内置变量，它的值是当前连接的用户名，类型为 nvarchar。 然后，拿一 个 nvarchar 的值跟 int 的数 0 比较，系统会先试图将 nvarchar 的值转成 int 型 ，当然，转的过程中肯定会出错。

   SQLServer 的出错提示是：将 nvarchar 值 ”abc” 转换数据类型为 int 的列时发生语法错误，abc 正是变量 user 的值 这样，不废吹灰之力就拿到了数据库的用户名

   众所周知， SQLServer 的用户 sa 是个等同 Adminstrators 权限的角色，拿到了 sa 权限， 几乎肯定可以拿到主机的 Administrator 了。上面的方法可以很方便的测试出 是否是用 sa 登录，要注意的是：如果是 sa 登录，提示是将”dbo”转换成 int 的列发生错误，而不是”sa”。 

   **途径二：从数据库系统表的判断入手** 

   

   如果服务器 IIS 不允许返回错误提示，那怎么判断数据库类型呢？ 首先， 我们可以从 Access 和 SQLServer 和区别入手，Access 和 SQLServer 都有自己 的系统表，比如存放数据库中所有对象的表，Access 是在系统表 [msysobjects]中，但在 Web 环境下读该表会提示“没有权限”，SQLServer 是在表[sysobjects]中，在Web环境下可正常读取。 然后在确认可以注入的情 况下，使用下面的语句： 

   `http://www.wenkuxiazai.com/showdetail.asp?id=49 and (select count(*) from sysobjects)>0`  

   `http://www.wenkuxiazai.com/showdetail.asp?id=49 and (select count(*) from msysobjects)>0` 

   结果分析：

    如果数据库是 SQLServer，那么第一个网址的页面与原页面 http://www.wenkuxiazai.com/showdetail.asp?id=49 是大致相 同的； 

   而第二个网址，由于找不到表 msysobjects，会提示出错， 就算程序有容错处理，页面也与原页面完全不同。 如果数据库用的 是 Access，那么情况就有所不同，第一个网址的页面与原页面完全 不同； 第二个网址，则视乎数据库设置是否允许读该系统表，一般 来说是不允许的，所以与原网址也是完全不同。 大多数情况下，用 第一个网址就可以得知系统所用的数据库类型，第二个网址只作为开 启 IIS 错误提示时的验证 

   

   

   ***<u>SQLmap 之 tamper 的使用</u>*** 

   

   ​	在我们注入的时候难免会遇到，一些网站对一些参数的过滤，或者连 接中断的情况，这时候心里不免有些觉得 mmp。这时候往往是网站 设置了 WAF（Web Application Firewall ）网站应用级入侵防御系 统，其实说的通俗点就是防火墙。那么在这种情况下我们就无法进行 注入了吗？当然不是，sqlmap 的作者想到了这一点，他给我们提供 了 tamper 这一个选项，在这里面我们可以调用 sqlmap 自带的脚本 或者是自己设计脚本来完成对我们注入语句的骚操作！他的原理基本 上就是对于 sql 语句的编码，从而绕过网站 waf 对参数的过滤。在使 用 sqlmap 中 tamper 的时候，一定要注意，我们要在安全等级大于 等于三的时候才能使用！

   

 **sqlmap 自带的 tamper 以及介绍**

 	打开我们下载的 sqlmap 所在目录，里面会有一个 tamper 的文件夹， 我们点进去 



文件名                                      	     作用 

apostrophemask.py  	       用 UTF-8 全角字符替换单引号字符 

apostrophenullencode. py    	  用非法双字节 unicode 字符替换单引号字符 

appendnullbyte.py 		在 payload 末尾添加空字符编码

 base64encode.py 		对给定的 payload 全部字符使用 Base64 编码

 between.py 		  分别用“NOT BETWEEN 0 AND #”替换大于号“>”， “BETWEEN # AND #”替换等于号“=” 

bluecoat.py 		  在 SQL 语句之后用有效的随机空白符替换空格符， 随后用“LIKE”替换等于号“=” chardoubleencode.py	 	 对给定的 payload 全部字符使用双重 URL 编码（不 处理已经编码的字符） charencode.py 		        对给定的 payload 全部字符使用 URL 编码（不处理 已经编码的字符）

 charunicodeencode.py 	 对给定的 payload 的非编码字符使用 Unicode URL 编码（不处理已经编码的字符） concat2concatws.py		  用“CONCAT_WS(MID(CHAR(0), 0, 0), A, B)”替换像 “CONCAT(A, B)”的实例

 equaltolike.py 						用“LIKE”运算符替换全部等于号“=” 

greatest.py                                                        用“GREATEST”函数替换大于号“>”

halfversionedmorekey words.py                         在每个关键字之前添加 MySQL 注释 

ifnull2ifisnull.py 		用“IF(ISNULL(A), B, A)”替换像“IFNULL(A, B)”的实例

 lowercase.py 用小写值替换每个关键字字符

 modsecurityversioned. py 用注释包围完整的查询

 modsecurityzeroversio ned.py 用当中带有数字零的注释包围完整的查询 

multiplespaces.py 在 SQL 关键字周围添加多个空格 

nonrecursivereplacem ent.py 用 representations 替换预定义 SQL 关键字，适用 于过滤器 

overlongutf8.py 	转换给定的 payload 当中的所有字符

 percentage.py	 在每个字符之前添加一个百分号

 randomcase.py 	随机转换每个关键字字符的大小写

 randomcomments.py 	向 SQL 关键字中插入随机注释

 securesphere.py 	添加经过特殊构造的字符串

 sp_password.py	 向 payload 末尾添加“sp_password” for automatic obfuscation from DBMS logs space2comment.py 用“/**/”替换空格符

 space2dash.py	 用破折号注释符“--”其次是一个随机字符串和一个 换行符替换空格符 

space2hash.py 用磅注释符“#”其次是一个随机字符串和一个换行 符替换空格符

 space2morehash.py 用磅注释符“#”其次是一个随机字符串和一个换行 符替换空格符 

​		详情请见：   http://p0sec.net/index.php/archives/29/







